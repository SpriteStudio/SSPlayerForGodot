name: release gdextension
on:
  workflow_dispatch:
    inputs:
      godot_tag:
        required: true
        type: string
        default: "4.4"
        description: "a branch or a tag of godot-cpp"

env:
  LANG: en_US.UTF-8
  LC_ALL: en_US.UTF-8
  PYTHONIOENCODING: utf8
  GODOT_VERSION_4: ${{ inputs.godot_tag }}

concurrency:
  group: ci-scons-${{ github.actor }}-${{ github.head_ref || github.run_number }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gdextension:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
#          - name: üêß Linux (GCC)
#            os: ubuntu-latest
#            platform: linux

          - name: üèÅ Windows (x86_64, MSVC)
            os: windows-latest
            platform: windows

          - name: üçé macOS (universal)
            os: macos-15
            platform: macos

          - name: ü§ñ Android (arm64)
            os: ubuntu-latest
            platform: android

          - name: üçè iOS (arm64)
            os: macos-15
            platform: ios

          - name: üåê Web (wasm32)
            os: ubuntu-latest
            platform: web

    defaults:
      run:
        shell: zsh {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: clone Godot Cpp repository
        uses: GuillaumeFalourd/clone-github-repo-action@v2.3
        with:
          depth: 1
          branch: ${{ env.GODOT_VERSION_4 }}
          owner: 'godotengine'
          repository: 'godot-cpp'

      - name: setup for gdextension
        uses: ./.github/actions/setup-extension
        with:
          platform: ${{ matrix.platform }}
          os: ${{ matrix.os }}

      - name: build Linux
        if: matrix.platform == 'linux'
        run: |
          ./scripts/release-gdextension-linux.sh

      - name: build macOS
        if: matrix.platform == 'macos'
        env:
          DEV_ID_APPLICATION: ${{ secrets.DEV_ID_APPLICATION }}
        run: |
          ./scripts/release-gdextension-macos.sh

          for f in ./bin/macos/macos.framework/*
          do
            codesign --force --verify --verbose --keychain ${{ env.KEYCHAIN_PATH }} --sign "${DEV_ID_APPLICATION}" $f --options runtime --timestamp
          done

      - name: build iOS
        if: matrix.platform == 'ios'
        env:
          DEV_ID_APPLICATION: ${{ secrets.DEV_ID_APPLICATION }}
        run: |
          ./scripts/release-gdextension-ios.sh

          for f in $(find ./bin/ios -name '*.dylib')
          do
            codesign --force --verify --verbose --keychain ${{ env.KEYCHAIN_PATH }} --sign "${DEV_ID_APPLICATION}" $f --options runtime --timestamp
          done

      - name: build Android
        if: matrix.platform == 'android'
        run: |
          ./scripts/release-gdextension-android.sh

      - name: build Windows
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          ./scripts/release-gdextension-windows.ps1

          Remove-Item -Recurse -Force ./bin/windows/*.exp
          Remove-Item -Recurse -Force ./bin/windows/*.lib

      - name: build Web
        if: matrix.platform == 'web'
        run: |
          ./scripts/release-gdextension-web.sh

      - id: commit
        uses: pr-mpt/actions-commit-hash@v3

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ matrix.platform }}-${{ steps.commit.outputs.short }}
          path: bin/
          if-no-files-found: error

  package:
    needs: gdextension
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - id: commit
        uses: pr-mpt/actions-commit-hash@v3

      - name: Zip all artifacts
        run: |
          cd artifacts

          mkdir -p bin
          cp ../misc/ssplayer_godot_extension.gdextension bin/

          mv extension-android-${{ steps.commit.outputs.short }}/android bin/
          mv extension-ios-${{ steps.commit.outputs.short }}/ios bin/
          mv extension-macos-${{ steps.commit.outputs.short }}/macos bin/
          mv extension-web-${{ steps.commit.outputs.short }}/web bin/
          mv extension-windows-${{ steps.commit.outputs.short }}/windows bin/
          # mv extension-linux-${{ steps.commit.outputs.short }}/linux bin/

          zip -r ../ssplayer-godot-extension-${{ steps.commit.outputs.short }}.zip ssplayer_godot_extension.gdextension bin/

      - name: Upload final release package
        uses: actions/upload-artifact@v4
        with:
          name: ssplayer-godot-extension-${{ steps.commit.outputs.short }}
          path: ssplayer-godot-extension-${{ steps.commit.outputs.short }}.zip
