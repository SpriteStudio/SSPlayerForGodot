name: CI

on:
  pull_request:
    branches:
      - main

env:
  GODOT_VERSION_4: 4.4
  GODOT_VERSION_3: 3.x
  PYTHONUTF8: 1

jobs:
  godot:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: üèÅ Windows (x86_64, MSVC)
            os: windows-latest
            platform: windows

          - name: üçé macOS (universal)
            os: macos-15
            platform: macos

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    - name: clone Godot repository
      uses: GuillaumeFalourd/clone-github-repo-action@v2.3
      with:
        depth: 1
        branch: ${{ env.GODOT_VERSION_4 }}
        owner: 'godotengine'
        repository: 'godot'

    - name: setup for godot
      uses: ./.github/actions/setup-godot
    - name: build godot
      if: inputs.platform == 'macos'
      run: |
        ./scripts/build.sh arch=universal compiledb=no strip=yes
    - name: build godot
      if: inputs.platform == 'windows'
      shell: pwsh
      run: |
        .\scripts\build.ps1

#  mac_build_3:
#    strategy:
#      matrix:
#        platform: macos-latest
#        version: ${{ env.GODOT_VERSION_3 }}
#    runs-on: ${{ matrix.platform }}
#    steps:
#    - uses: actions/checkout@v4
#      with:
#        submodules: 'recursive'
#    - name: clone Godot repository
#      uses: GuillaumeFalourd/clone-github-repo-action@v2.3
#      with:
#        depth: 1
#        branch: ${{ matrix.version }}
#        owner: 'godotengine'
#        repository: 'godot'
#    - name: prepare scons
#      run: |
#          brew install python3 scons
#    - name: build godot
#      run: |
#        ./scripts/build_v3.sh
#
#  win_build_3:
#    strategy:
#      matrix:
#        platform: windows-latest
#        version: ${{ env.GODOT_VERSION_3 }}
#    runs-on: ${{ matrix.platform }}
#    steps:
#    - uses: actions/checkout@v4
#      with:
#        submodules: 'recursive'
#    - name: clone Godot repository
#      uses: GuillaumeFalourd/clone-github-repo-action@v2.3
#      with:
#        depth: 1
#        branch: ${{ matrix.version }}
#        owner: 'godotengine'
#        repository: 'godot'
#    - name: Setup Python and SCons
#      uses: ./godot/.github/actions/godot-deps
#    - name: Download pre-built ANGLE static libraries
#      uses: dsaltares/fetch-gh-release-asset@1.1.2
#      with:
#        repo: godotengine/godot-angle-static
#        version: tags/chromium/6029
#        file: Windows.6029-1.MSVC_17.x86_64.x86_32.zip
#        target: angle/angle.zip
#
#    - name: Extract pre-built ANGLE static libraries
#      run: Expand-Archive -Force angle/angle.zip ${{github.workspace}}/
#
#    - name: Setup MSVC problem matcher
#      uses: ammaraskar/msvc-problem-matcher@master
#
#    - name: build godot
#      shell: pwsh
#      run: |
#        $env:PYTHONUTF8=1
#        .\scripts\build-v3.ps1
